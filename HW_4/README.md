# Домашнее задание 4
## Fauna DB
### История
Об истории этой БД мало где написано. Но вот те крупицы информации которую получилось найти.  
FaunaDB была основана в 2012 году Эваном Вивианом, бывшим техническим директором Twitter, и Мэттью Фонтейном, бывшим инженером Google. FaunaDB вдохновлен Calvin и является единственной коммерческой системой баз данных, которая на сегодняшний день реализует этот протокол.   
База данных была разработана таким образом, чтобы быть масштабируемой, отказоустойчивой и высокодоступной. Он также был создан для работы с транзакциями, что означает, что он мог обрабатывать сложные транзакции, включающие несколько типов данных и операций.  
  
На разработку FaunaDB большое влияние оказала работа, проделанная над базой данных Google Spanner, которая была разработана для работы с крупномасштабными глобально распределенными системами. FaunaDB использует архитектуру, аналогичную Spanner, но с некоторыми ключевыми отличиями. Например, FaunaDB разработан таким образом, чтобы быть более гибким и простым в использовании, чем Spanner.  
  
С момента своего выпуска FaunaDB завоевала популярность среди разработчиков, которым нужна масштабируемая многомодельная база данных, способная обрабатывать сложные транзакции. База данных используется, в частности, такими компаниями, как Twitter, Verizon и Capital One. В 2017 году FaunaDB была перезапущена как облачный сервис баз данных, который предоставляет гибкую и масштабируемую платформу для разработки современных приложений. 
  
Сегодня FaunaDB используется компаниями в различных отраслях, включая финансы, медиа, здравоохранение и многие другие. Недавно FaunaDB объединилась с JAMstack-платформой Netlify, чтобы предоставить разработчикам более простой и быстрый способ создания современных приложений. Совместное решение позволяет разработчикам создавать и развертывать приложения на основе JAMstack, используя FaunaDB для хранения и обработки данных. Это партнерство также дает возможность использовать функции Netlify для обработки запросов к базе данных FaunaDB.
### Инструменты
Fauna является cloud решением поэтому очевидно, что основным инструментом взаимодействия с ней является [сайт](https://fauna.com).    
На сайте создаём аккаунт. После этого можем пользоваться).  
Далее для работы с ней есть множество разных способов:
1. С помощью языков программирования, например Python(так же поддерживаются JS, C#, Java, Scala, Go, Swift, Ruby) 
   1. Установка 
   ```bash
    pip intall pipenv
    pipenv shell
    pipenv install faunadb
   ```
   2. Пример программы
   ```python
    # file main.py
    # Import required packages including the driver
    import os
    from urllib.parse import urlparse
    from faunadb import query as faunaquery
    from faunadb.client import FaunaClient

    try:
        secret = "DB_ACCESS_KEY" # Insert your access key here(USE ENVIRONMENT VARIABLES)
        endpoint = "DB_ENDPOINT" # Insert your endpoint here(USE ENVIRONMENT VARIABLES)

        database_url = urlparse(endpoint)

        # Instantiate the FaunaDB client
        client = FaunaClient(
            secret=secret,
            domain=database_url.hostname,
            port=database_url.port,
            scheme=database_url.scheme
        )

        # Create a Collection
        query_result = client.query(faunaquery.create_collection({"name": "testCollection"}))

        # Print the Result of the Query
        print(f"FaunaDB Collection Creation: \n {query_result}")
        
            query_result = client.query(
            faunaquery.map_(
                lambda username: faunaquery.create(
                    faunaquery.collection("testCollection"),
                    {"data": {"name": username}}
                ),
                [
                "Barry",
                "Sam",
                "Ashley",
                "Kat",
                "Nathan"
                ]
            )
        )

        # Print the Result of the Query
        print(query_result)
        
        # Retrieve Data from Reference ID
        query_result = client.query(
            faunaquery.get(
                faunaquery.ref(
                    faunaquery.collection("testCollection"), "INSERT REFERENCE ID")
                )
            )
        #Update data
        query_result = client.query(
            faunaquery.update(
                faunaquery.ref(
                    faunaquery.collection("testCollection"), "328031285277622849"),
                    { "data": {"name" : "Barry Allen", "email": "barry@gmail.com"}}
                )
            )
        #Delete Data
        query_result = client.query(
            faunaquery.delete(
                faunaquery.ref(
                    faunaquery.collection("testCollection"), "328031285277622849")
                )
            )

    except Exception as error:
        print(f"Error occurred : {error}")
   ```
   3. Запуск
   ```bash
   pipenv run main.py
   ```
2. Интерактивно(нужен установленный Node.js)
   1. Установка
   ```bash
   npm install -g fauna-shell
   ```
   2. Подключение
   ```bash
   fauna cloud-login
   # вводим email/password
   ```
   3. Работа
    ```bash
    # создаём БД
    fauna create-database my-db

    # Подключаемя к ней
    fauna shell my-db

    # Можем создать колекцию
    my-db> CreateCollection({name:"blog-posts"})

    # Создадим индекс
    my-db> CreateIndex({name: "posts_by_title",
    ...   source: Collection("blog-posts"),
    ...   terms: [{field: ["data", "title"]}]})

    # Создадим документ
    my-db> Create(Collection("blog-posts"),
    ... {data: {title: "Fauna: An Introduction",
    ..... content: "Fauna is a wonderful Database. You must use it in your application"}})

    # Пример запроса:
    my-db> Get(Match(Index("posts_by_title"), "Title 2"))
    ```
### Database engine
Я не нашёл информацию в открытом доступе и документации.  
Но наткунля на утверждение что FaunaDB использует свой собственный проприетарный движок, который был разработан специально для базы данных.
### Язык запросов
Т.к. FaunaDB это мульти-модальная СУБД, поддерживается два языка запросов: 
1. GraphQL - для работы с графовыми данными
2. FaunaQL(FQL) - для работы с остальными

Но есть некоторые ограничения на GraphQL т.к. API Fauna GraphQL находится в начальной версии. Он функционален и может обрабатывать большинство рабочих нагрузок GraphQL. Однако есть некоторые функции GraphQL, которые в настоящее время не поддерживаются.  
1. Схемы не поддерживают:
   1. Пользовательские директивы
   2. Пользовательские интерфейсы
   3. Пользовательские скаляры
   4. Типы объединений(Union)
2. Никакое имя не может начинаться с символа подчеркивания (_)
3. Subscriptions не поддерживаются.

Кроме того, Fauna GraphQL API может работать только с определенной схемой. Любые существующие коллекции, индексы или функции, которые могут существовать в базе данных и на которые нет ссылок в схеме GraphQL, недоступны для запросов GraphQL.

По языку FQL есть [документация](https://docs.fauna.com/fauna/current/api/fql/)(по моему мнению довольно скудная)

Разворачивать Базу Данных не нужно, т.к. Fauna это облачный сервис.   
Но если очень хочеться то есть [FaunaDev](https://docs.fauna.com/fauna/current/build/tools/dev) по сути образ для докера.  
Процесс подключения описанн выше но здесь могу повторить:
```bash
# установка fauna-shell
$ npm install -g fauna-shell

# Подключение к fauna(login/password). 
# На самом деле просто это этап создания config'a
$ fauna cloud-login

# Создаем базу-данных
$ fauna create-database my_db

# Подклбчаемя
$ fauna shell my_db
```

Напишем теперь несколько запросов
```bash
# Создадим колекцию
my_db> CreateCollection({ name: "books" })

# Создадим в ней индекс
my_db> CreateIndex({
    name: "books_title",
    source: Collection("books")
    terms: [{ field: ["data", "title"] }]
})

# Добавим первый документ в неё
my_db> Create(
    Collection("books"),
    {data: { title: "Otci i deti" } }
)
# получим примерно такой ответ
# { ref: Ref(Collection("books"), "1580127520198"),
#  ts: 7123753912721924,
#  data: { titolo: "Otci i deti" } }

# Множественная вставку можно сделать используя функцию Map
my_db> Map(
    [
        "Voina i mir",
        "Domik u ozera",
        "Gore ot uma"
    ],
    Lambda("book_title",
        Create(
            Collection("books"), { data: { title: Var("book_title") } }
        )
    )
)

# Для получения результатов можно использовать ID
my_db> Get(Ref(Collection("songs"), "1580127520198"))

# Или по индексу
my_db> Get(
    Match(
        Index("books_title"),
        "Voina i mir"
    )
)
```

### Возможно ли распределение файлов БД по разным носителям
Да, возможно распространять файлы FaunaDB на разных носителях. FaunaDB использует распределенную архитектуру, которая позволяет хранить данные и получать к ним доступ с нескольких узлов. Это означает, что данные могут храниться на разных серверах, в разных центрах обработки данных или даже в разных регионах или странах. Кроме того, FaunaDB поддерживает репликацию и синхронизацию, что означает, что данные могут автоматически копироваться и обновляться на нескольких узлах, обеспечивая высокую доступность и долговечность данных.
### На каком языке написана БД
FaunaDB была написана на Scala и Java и работает на JVM в нескольких операционных системах, включая Linux, Windows и OS X.
### Какие типы инексов поддерживаются
Fauna использует [log-structed merge-tree](https://en.wikipedia.org/wiki/Log-structured_merge-tree) индксы.  


Индекс может определять термины: это ноль или более объектов-терминов, которые определяют, какие поля документа использовать для поиска. Термины сопоставимы с предикатами column=value в предложении SQL WHERE. Например, если в ваших документах есть поле "name", вы можете определить термины, включающие это поле, и затем вы сможете найти все документы, соответствующие "name".  


Индекс может определять значения: это ноль или более скалярных значений, возвращаемых для каждой записи индекса, которая соответствует условиям при запросе индекса. значения сопоставимы с предложением SQL SELECT.
Значения - это также способ сортировки индексов: каждое значение поля в values сортируется лексически в соответствии с типом поля, и порядок можно изменить, установив reverse: true.

Индекс, в котором не определены термины и значения, известен как *collection index*: поиск документов невозможен, и все документы в коллекции включаются в результирующий набор и сортируются по их ссылке в порядке возрастания.

Для индексов можно так-же включить/выключить сюреализацию, уникальность или настроить права доступа.
### Как строится процесс выполнения запросов
Т.к. Fauna это проприетарная субд информации в документации не так много.   
Запрос выполняется путем отправки его в Fauna, которая вычисляет и возвращает результат. Выполнение запроса является транзакционным: никакие изменения не фиксируются, если что-то идет не так. Если запрос завершается неудачей, вместо результата возвращается ответ об ошибке. Скорее всего запрос выполняется в несколько этапов:
1. Проверка соответсвия запроса схеме и политикам безопасности
2. Оптимизация
3. Выполнение запроса на разных узлах
### Есть ли план запроса? Если да то как работает данный этап?
Опять же таки, нет никакой подробной информации, но я узнал что Fauna предостовляет сервис [Fauna Logs](https://fauna.com/blog/announcing-fauna-logs) для оптимизации запросов и плюс опять же таки по найденой мной инфорации(из предыдущего пункта) есть этап оптимизации запроса. Поэтому  скорее всего, да, в FaunaDB есть планировщик запросов.
### Поддерживаются ли транзакции?
Выписка из документации:
> Fauna — это платформа распределенной базы данных, поддерживающая строго сериализуемые внешне согласованные транзакции. В отличие от Google Spanner или подобных систем, Fauna не полагается на физическую синхронизацию часов для обеспечения согласованности. Кроме того, в отличие от Google Percolator, FoundationDB или подобных систем, Fauna не накладывает ограничений на расстояние между репликами и удобна для развертывания при глобальных задержках в Интернете.
> 
> 
> Протокол Fauna, который был вдохновлен Calvin, определяет последовательный порядок перед выполнением любых операций записи в базу данных. Для каждого пакета параллельных транзакций чтения-записи они вставляются в распределенный журнал транзакций с опережением записи, и механизм выполнения Fauna гарантирует, что конечный результат обработки этого пакета транзакций эквивалентен тому, как если бы они обрабатывались одна за другой в том порядке, в котором они появились в этом предварительно сгенерированном журнале.
### Какие методы восстановления поддерживаются
Для этого в Fauna есть фукнция backup'ов посредством создания снимков бд(snapshot'ов)(подробнее [тут](https://docs.fauna.com/fauna/current/learn/understanding/backups)).   
И так же есть механизм связанный с языком запросов FQL. А именно одна из её особенностей: Temprotality(подробнее [тут](https://fauna.com/blog/core-fql-concepts-part-2-temporality-in-faunadb)).  
>Одной из главных временных особенностей Fauna является возможность записывать каждое изменение, которое вы вносите в документ. Когда это настроено, новые моментальные снимки документа создаются при каждом изменении и добавляются в историю документа. По умолчанию при создании коллекции мы получаем минимальную историю документов за 30 дней.
>
>Следует отметить, что наличие разрешений на чтение документа автоматически не дает разрешения на чтение или изменение его истории. Вашим пользователям потребуются специальные разрешения, чтобы иметь возможность взаимодействовать с историей документа.
### Расскажите про шардинг
Как писалось выше Fauna поддерживает шардинг(вертикальный и горизонтальный scaling).  
У них даже есть [статья](https://fauna.com/blog/how-to-scale-a-database) о том как и зачем это нужно делать. 
Более того этот scaling [мульти-региональный](https://fauna.com/blog/multi-region-scaling-with-fauna).  
Плюс т.к. Fauna - облачный сервис вам не нужно настраивать шардинг в ручную он уже есть. Вот плюшки которые предостовляет шардинг Faun'ы:
1. **It scales automagically** Fauna с самого начала была создана как глобально распределенная база данных с несколькими центрами обработки данных, активная и бессерверная. Он отличается высокой масштабируемостью, поскольку его архитектура на основе Calvin допускает как горизонтальное, так и вертикальное масштабирование и гарантирует, что каждый узел в кластере Fauna выполняет те же роли (в отличие от многих других распределенных баз данных), что и координатор запросов, реплика данных и реплика журнала. Прелесть этой архитектуры в том, что подготовка узлов кластера и управление ими происходят полностью за кулисами, не беспокоя вас.
2. **Low latency** Обращения к базе данных обходятся дорого. Чтобы повысить производительность базы данных и улучшить пользовательский интерфейс за счет снижения задержки ответа, вам необходимо максимально сократить количество обращений к вашей базе данных. Fauna делает именно это, группируя транзакции и применяя их по географическим регионам, так что вы можете просматривать и обновлять несколько коллекций в одном запросе.  Fauna по-прежнему зависит от задержки во внешней сети. Низкая задержка закладывает основу для обеспечения надежной или немедленной согласованности. Многие варианты использования требуют строгой согласованности для работы, например, высокочастотная торговля, банковское дело или системы бронирования больших объемов. Если вы попытаетесь использовать MongoDB или CockroachDB для этих вариантов использования, возможно, вам не удастся эффективно масштабировать их.
3.  **ACID** Только Fauna внедрила протокол в стиле Calvin, который гарантирует высочайший уровень сериализации транзакций без использования тактовых импульсов и без увеличения задержки. Fauna использует строгую сериализуемость, чтобы обеспечить согласованность между всеми узлами во всех географических регионах и предотвратить устаревшие чтения. Это достигается за счет сохранения позиции в журнале, которая помогает гарантировать монотонно увеличивающееся число глобальных транзакций. Чтобы обеспечить монотонность порядка транзакций, каждый из центров обработки данных Fauna использует схему синхронизации для совместного использования позиции журнала со всеми координаторами запросов. Fauna также публично делится системной информацией.
4.  **It provides security natively**  Fauna обладает множеством функций безопасности баз данных, которые обычно приходится создавать отдельно для других баз данных. В дополнение к стандартному детальному управлению доступом на основе атрибутов, Fauna предлагает интеграцию OAuth 2.0 "из коробки". Вы можете использовать поставщика удостоверений для аутентификации ваших пользователей в Fauna.  Основанный на ключах API Fauna отлично подходит для аутентификации соединений с определенными разрешениями вплоть до уровня объектов базы данных. Даже после аутентификации запросы используют дальнейшую аутентификацию на основе токенов в каждом конкретном случае. Вероятно, вам понадобится менеджер аренды токенов, такой как HashiCorp Vault, чтобы сделать это для другой базы данных. Эта функция недоступна ни в MongoDB, ни в CockroachDB.
5.  В FQL все возвращает значения. Это позволяет вам использовать сложные структуры управления и условные обозначения для обработки и вычисления ваших данных в нужном вам виде. Вы также можете использовать сочетание этих интерфейсов для разработки своих приложений. Если вы собираетесь запрашивать документы, реляционные данные, графические данные или комбинацию всего этого, вы должны быть в состоянии сделать это довольно легко с помощью Fauna. FQL также позволяет вам запрашивать различные типы данных. Например, вы можете использовать функцию темпоральности Fauna для выдачи запросов на определенный момент времени (PIT). Это особенно полезно при работе с данными временных рядов или потоковыми данными, что является реальной возможностью для Fauna. В то время как MongoDB изначально поддерживает потоковую передачу данных, CockroachDB имеет ограниченную поддержку потоковой передачи, которой вы можете воспользоваться, создав поверх нее.
### Применимы ли термины DataMining, Data Warehousing или OLAP
К сожалению DataWarehouse это не про FaunaDB(т.к. это опять таки облачный сервис), однако её можно интегрировать(например натроить pipe между Fauna и вашим хранилищем) вот [пример инструмента для этого](https://retool.com/integrations/faunadb).  

Термин DataMining наверное можно применить в FaunaDB т.к. FaunaDB предоставляет мощные возможности поиска и индексации, которые можно использовать для выполнения задач  анализа данных, таких как выявление корреляций, кластеризация и классификация. Кроме того, FaunaDB поддерживает интеграцию с популярными инструментами обработки данных и аналитики, такими как Python, R и Jupyter notebook, что делает его полезным инструментом для анализа данных.  

Термин OLAP не применим к FaundaDB. Об этом даже говорил co-founder компании Fauna в [интервью](https://changelog.com/podcast/461).
### Какие методы защиты
Соединения с базой данных защищены с помощью протокола HTTPS. Аутентификация и контроль доступа реализуются с использованием токенов-носителей HTTP в заголовке запроса для каждого запроса.

Фауна предоставляет две модели безопасности для доступа:
1. **identity-based access** В этой модели запросы имеют связанный идентификатор, хранящийся в базе данных или у внешнего поставщика идентификационных данных, который идентифицирует субъекта, выполняющего каждый запрос. Доступ на основе идентификационных данных обычно используется приложениями для обеспечения детального контроля доступа или для изменения поведения запросов на основе идентификационных данных субъекта, который запрашивает базу данных.
2. **anonymous-based access** В этой модели запросы не имеют связанного идентификатора. Доступ основан на роли, где роль предоставляет определенные привилегии. Анонимный доступ обычно используется разработчиками приложений и фоновыми задачами, которым требуется либо глобальный доступ, либо узконаправленный доступ, где идентификация не важна.
   
Чтобы использовать эти модели безопасности, Fauna предоставляет следующие ресурсы: секреты, [ABAC](https://en.wikipedia.org/wiki/Attribute-based_access_control), токены, [JWT(JSON Web Token)](https://en.wikipedia.org/wiki/JSON_Web_Token),  ключи.
### Какие сообщества развивают СУБД
СУБД Fauna в данный момент разрабатывается компанией Fauna(3500+ разработчиков), а не открытым сообществом.  
Тем не менее у них есть форум, дискорд канал и различные соцсети(ссылки в конце), которые они постоянно мониторят.  
Плюс у них есть что-то типо программы амбасадоров которые первыми получают ранний доступ к новым фичам, swag и специальным ивентам. Называется *Fauna Champions*. Что бы присоединится нужно написать письмо на почту community@fauna.com с темой **"I'd like to be a Fauna Champion"**
 
К сожалению информацию о команде разроботчиков не нашёл(наверное можно поискать по профилям на LinkedIn'e)
### Создайте свои собственные базы данных для примера
Примеры были выше
### Как продолжить самостоятельное изучение языка
По документации, статьям в интернете, блогу на [DevTo](https://dev.to/fauna), [Youtube](https://www.youtube.com/channel/UCTkGE215CjAkcRO5mDMmLkw).
### Где найти документацию и пройти обучение
[Документация](https://docs.fauna.com/fauna/current/)   
Нашёл несколько курсов(все на английском):  
1. [Educative](https://www.educative.io/courses/distributed-systems-practitioners/JYv2k3kNjOg)  
2. [egghead](https://egghead.io/courses/the-complete-guide-to-faunadb-74bef44b)  
3. [fireship](https://fireship.io/lessons/fauna-db-quickstart/)
### Как быть в курсе происходяшего
Страница с новостями [новостями](https://fauna.com/press) + блоги и соцсети(сслыки ниже)
### Некоторые ссылки
1. [Документация](https://docs.fauna.com/fauna/current/)  
2. [Новости](https://fauna.com/press)
3. [Статья про безопасность](https://docs.fauna.com/fauna/current/security/)
4. [Интервью с Co-Founder'ом Faun'ы Эваном Уивером](https://www.ibm.com/blog/database-deep-dives-faunadb/)  
5. [Ещё одно интервью с Эваном Уивером](https://changelog.com/podcast/461)
6. [Форум](https://forums.fauna.com/)
7. [Дискорд канал](https://discord.com/invite/NHwJFdG2B2)
8. [DevTo](https://dev.to/fauna)
9. [Twitter](https://twitter.com/fauna)
10. [LinkedIn](https://www.linkedin.com/company/faunadb)
11. [Youtube](https://www.youtube.com/channel/UCTkGE215CjAkcRO5mDMmLkw)